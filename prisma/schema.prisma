/**
 * Archivo: schema.prisma
 *
 * ¡VERSIÓN FINAL DE LA FASE 4!
 * Incluye todos los modelos y relaciones:
 * User, Product, Category, Supplier, MovementReason, InventoryMovement.
 */

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --- ENUM ---
// Define los únicos dos tipos de movimientos permitidos
enum MovementType {
  IN  // Entrada de stock (compras, devoluciones de clientes)
  OUT // Salida de stock (ventas, ajustes por rotura)
}


// --- MODELO USER ---
model User {
  id        String   @id @default(cuid())
  name      String?
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products         Product[]
  categories       Category[]
  suppliers        Supplier[]
  movements        InventoryMovement[]
  movementReasons  MovementReason[] // <-- RELACIÓN NUEVA
}

// --- MODELO PRODUCT ---
model Product {
  id          String    @id @default(cuid())
  name        String
  description String?   @db.Text
  price       Float
  sku         String    @unique
  quantity    Int       @default(0) 
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  authorId   String
  author     User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  
  movements InventoryMovement[] 

  @@index([sku])
  @@index([authorId])
  @@index([categoryId])
  @@index([supplierId])
}

// --- MODELOS DE SOPORTE ---
model Category {
  id   String @id @default(cuid())
  name String

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  products Product[]

  @@index([authorId])
  @@unique([authorId, name])
}

model Supplier {
  id          String  @id @default(cuid())
  name        String
  contactName String?
  phone       String?
  email       String?

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  products Product[]

  @@index([authorId])
}


// --- ¡MODELO NUEVO! ---
model MovementReason {
  id        String       @id @default(cuid())
  name      String       // Ej: "Venta", "Compra", "Merma"
  type      MovementType // Indica si es para entradas o salidas
  authorId  String
  author    User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  movements InventoryMovement[] 

  @@index([authorId])
  @@unique([authorId, name])
}


// --- MODELO InventoryMovement (ACTUALIZADO) ---
model InventoryMovement {
  id        String       @id @default(cuid())
  type      MovementType
  quantity  Int
  notes     String?      @db.Text
  createdAt DateTime     @default(now())

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  authorId  String
  author    User    @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  reasonId  String? // La clave foránea al motivo (Opcional)
  reason    MovementReason? @relation(fields: [reasonId], references: [id], onDelete: SetNull)

  // Índices
  @@index([productId])
  @@index([authorId])
  @@index([reasonId]) 
}
